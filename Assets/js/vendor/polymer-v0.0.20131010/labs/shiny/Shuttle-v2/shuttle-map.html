<!--
/*
 * Copyright 2013 The Polymer Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->

<link rel="import" href="../../../more-elements/google-map/google-map.html">
  
<polymer-element name="shuttle-map" attributes="centerStop fromStop toStop filteredStops selectedFilteredStop">
  <template>
    <style>
      @host {
        * {
          display: block;
        }
      }
      
      google-map {
        display: block;
        height: 100%;
      }
    </style>
    
    <google-map id="map" zoom="10"></google-map>
  </template>
  <script>
    Polymer('shuttle-map', {
      opened: false,
      resize: function() {
        this.resizeJob = this.job(this.resizeJob, this._resize, 100);
      },
      _resize: function() {
        requestAnimationFrame(function() {
          this.$.map.resize();
        }.bind(this));
      },
      centerStopChanged: function() {
        if (this.centerStop) {
          this.$.map.latitude = this.centerStop.in_lat;
          this.$.map.longitude = this.centerStop.in_lon;
        }
      },
      filteredStopsChanged: function(old) {
        this.markers && this.markers.forEach(function(m) {
          m.setMap(null);
        });
        this.markers = [];
        this.opened = !!this.filteredStops;
        this.filteredStops && this.filteredStops.forEach(function(s) {
          if (s.hidden) {
            return;
          }
          var latLng = new google.maps.LatLng(s.in_lat, s.in_lon);
          if (this.markerExists(latLng)) {
            return;
          }
          var marker = new google.maps.Marker({
            map: this.$.map.map,
            position: latLng,
            icon: 'assets/marker_grey.png'
          });
          this.markers.push(marker);
          google.maps.event.addListener(marker, 'click', 
              this.selectStop.bind(this, s));
        }, this);
      },
      markerExists: function(latLng) {
        for (var i = 0, m; m = this.markers[i]; i++) {
          if (m.getPosition().equals(latLng)) {
            return true;
          }
        }
      },
      selectStop: function(stop) {
        this.selectedFilteredStop = stop;
      },
      fromStopChanged: function() {
        this.asyncPlotRoute();
      },
      toStopChanged: function() {
        this.asyncPlotRoute();
      },
      asyncPlotRoute: function() {
        this.plotRouteJob = this.job(this.plotRouteJob, this.plotRoute, 1);
      },
      plotRoute: function() {
        if (!this.fromStop || !this.toStop) {
          return;
        }
        if (!this.dirService) {
          this.dirService = new google.maps.DirectionsService();
          this.dirDisplay = new google.maps.DirectionsRenderer({
            suppressInfoWindows: true,
            suppressMarkers: true,
            preserveViewport: true
          });
          this.fromMarker = new google.maps.Marker({
            map: this.$.map.map,
            icon: 'assets/marker_greenA.png',
            zIndex: 1000
          });
          this.toMarker = new google.maps.Marker({
            map: this.$.map.map,
            icon: 'assets/marker_redB.png',
            zIndex: 1000
          });
          this.dirDisplay.setMap(this.$.map.map);
        }
        var request = {
            origin: new google.maps.LatLng(
                this.fromStop.in_lat, this.fromStop.in_lon),
            destination: new google.maps.LatLng(
                this.toStop.in_lat, this.toStop.in_lon),
            optimizeWaypoints: true,
            travelMode: google.maps.TravelMode.DRIVING
        };
        this.dirService.route(request, function(response, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            this.dirDisplay.setDirections(response);
            var leg = response.routes[0].legs[0];
            this.fromMarker.setPosition(leg.start_location);
            this.toMarker.setPosition(leg.end_location);
          }
        }.bind(this));
      }
    });
  </script>
</polymer-element>